import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import CallbackContext
from config import ADMIN_ID, MANDATORY_CHANNELS, CATEGORIES
from database import db

logger = logging.getLogger(__name__)


async def check_subscription(update: Update, context: CallbackContext) -> tuple:
    """Obunani tekshirish - foydalanuvchi barcha majburiy kanallarga obunami?"""
    user_id = update.effective_user.id
    not_subscribed = []
    channel_info = []
    
    for channel in MANDATORY_CHANNELS:
        channel = channel.strip()
        if not channel:
            continue
        
        try:
            member = await context.bot.get_chat_member(
                chat_id=f"@{channel}",
                user_id=user_id
            )
            
            if member.status in ["left", "kicked"]:
                not_subscribed.append(channel)
                # Kanal haqida ma'lumot olish
                try:
                    chat = await context.bot.get_chat(f"@{channel}")
                    channel_info.append({
                        "username": channel,
                        "title": chat.title or channel
                    })
                except:
                    channel_info.append({
                        "username": channel,
                        "title": channel
                    })
        except Exception as e:
            logger.warning(f"âš ï¸ Kanal tekshirishda xatolik @{channel}: {e}")
            not_subscribed.append(channel)
            channel_info.append({
                "username": channel,
                "title": channel
            })
    
    return len(not_subscribed) == 0, not_subscribed, channel_info


async def show_main_menu(update: Update, context: CallbackContext, user_name: str):
    """Asosiy menyuni ko'rsatish"""
    # Kategoriya tugmalari (2 tadan qator)
    buttons = []
    row = []
    
    for i, (code, cat) in enumerate(CATEGORIES.items(), 1):
        row.append(InlineKeyboardButton(
            f"{cat['emoji']} {cat['name']}",
            callback_data=f"cat_{code}"
        ))
        if i % 2 == 0:  # Har 2 tadan keyin yangi qator
            buttons.append(row)
            row = []
    
    if row:  # Qolgan tugmalar
        buttons.append(row)
    
    # Qo'shimcha tugmalar
    buttons.append([
        InlineKeyboardButton("ğŸ“‹ KINOLAR RO'YXATI", callback_data="show_movielist"),
        InlineKeyboardButton("ğŸ†˜ YORDAM", callback_data="show_help")
    ])
    
    await update.message.reply_text(
        f"ğŸ‘‹ Assalomu alaykum, <b>{user_name}</b>!\n"
        f"ğŸ¥ Kino Botiga xush kelibsiz!\n\n"
        f"Quyidagi kategoriyalardan birini tanlang yoki "
        f"kino kodini kiriting:",
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )


async def show_subscription_message(update: Update, channels_info: list):
    """Obuna bo'lmagan kanallar uchun xabar"""
    text = "ğŸ”’ <b>BOTDAN FOYDALANISH UCHUN OBUNA BO'LING</b>\n\n"
    text += "ğŸ“¢ <b>MAJBURIY KANALLAR:</b>\n"
    
    for ch in channels_info:
        text += f"â””â”€ ğŸ“Œ <a href='https://t.me/{ch['username']}'>{ch['title']}</a>\n"
    
    text += "\nâœ… <b>Barcha kanallarga obuna bo'lib, tugmani bosing!</b>"
    
    buttons = []
    for ch in channels_info:
        buttons.append([InlineKeyboardButton(
            f"ğŸ“¢ {ch['title']}",
            url=f"https://t.me/{ch['username']}"
        )])
    
    buttons.append([InlineKeyboardButton(
        "âœ… OBUNA BO'LDIM",
        callback_data="check_subscription"
    )])
    
    await update.message.reply_text(
        text,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML",
        disable_web_page_preview=True
    )


async def start(update: Update, context: CallbackContext) -> None:
    """START komandasi - asosiy kirish nuqtasi"""
    user_id = update.effective_user.id
    user_name = update.effective_user.full_name
    username = update.effective_user.username
    
    logger.info(f"ğŸ“¥ /start: {user_name} ({user_id})")
    
    # 1. OBUNANI TEKSHIRISH
    is_subscribed, _, channels_info = await check_subscription(update, context)
    
    if not is_subscribed:
        await show_subscription_message(update, channels_info)
        return
    
    # 2. FOYDALANUVCHINI DATABASEGA QO'SHISH
    is_new = db.add_user(str(user_id), username, user_name)
    
    # 3. AGAR YANGI FOYDALANUVCHI BO'LSA, ADMINGA XABAR
    if is_new and user_id != ADMIN_ID:
        try:
            admin_text = (
                f"ğŸ†• <b>YANGI FOYDALANUVCHI</b>\n\n"
                f"ğŸ‘¤ Ism: {user_name}\n"
                f"ğŸ†” ID: <code>{user_id}</code>\n"
                f"ğŸ“± Username: @{username if username else 'yoq'}\n"
                f"ğŸ“… Sana: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            )
            await context.bot.send_message(
                chat_id=ADMIN_ID,
                text=admin_text,
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"Adminga xabar yuborishda xatolik: {e}")
    
    # 4. ASOSIY MENYUNI KO'RSATISH
    await show_main_menu(update, context, user_name)
    
    logger.info(f"âœ… Foydalanuvchi qo'shildi: {user_name} ({user_id})")


async def handle_back_to_main(update: Update, context: CallbackContext):
    """Orqaga - asosiy menyuga qaytish"""
    query = update.callback_query
    await query.answer()
    
    user_name = update.effective_user.full_name
    
    # Asosiy menyu tugmalari
    buttons = []
    row = []
    
    for i, (code, cat) in enumerate(CATEGORIES.items(), 1):
        row.append(InlineKeyboardButton(
            f"{cat['emoji']} {cat['name']}",
            callback_data=f"cat_{code}"
        ))
        if i % 2 == 0:
            buttons.append(row)
            row = []
    
    if row:
        buttons.append(row)
    
    buttons.append([
        InlineKeyboardButton("ğŸ“‹ KINOLAR RO'YXATI", callback_data="show_movielist"),
        InlineKeyboardButton("ğŸ†˜ YORDAM", callback_data="show_help")
    ])
    
    await query.edit_message_text(
        f"ğŸ‘‹ <b>{user_name}</b>, asosiy menyuga qaytdingiz!\n\n"
        f"Quyidagi kategoriyalardan birini tanlang:",
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )


async def show_help(update: Update, context: CallbackContext):
    """Yordam xabarini ko'rsatish"""
    query = update.callback_query
    await query.answer()
    
    help_text = (
        "ğŸ†˜ <b>YORDAM</b>\n\n"
        "ğŸ“Œ <b>QANDAY ISHLATILADI?</b>\n"
        "1. Kategoriya tanlang (Kino/Serial/Multfilm)\n"
        "2. Kino kodini kiriting (masalan: 123)\n"
        "3. Kinoni tomosha qiling\n\n"
        
        "ğŸ“Œ <b>KINO KODI QANDAY TOPILADI?</b>\n"
        "â€¢ /movielist - barcha kinolar ro'yxati\n"
        "â€¢ Har bir kinoning o'z kodi bor\n\n"
        
        "ğŸ“Œ <b>AGAR SERIAL BO'LSA?</b>\n"
        "â€¢ Serial kodini kiriting\n"
        "â€¢ Qaysi qism kerakligini tanlang\n\n"
        
        "ğŸ“Œ <b>MUAMMO BO'LSA?</b>\n"
        "â€¢ @Admin ga murojaat qiling"
    )
    
    buttons = [[InlineKeyboardButton("ğŸ  ASOSIY MENYU", callback_data="back_to_main")]]
    
    await query.edit_message_text(
        help_text,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )


# Import qilish uchun
from datetime import datetime

# Handlerlar
start_handler = CommandHandler("start", start)
back_handler = CallbackQueryHandler(handle_back_to_main, pattern="^back_to_main$")
help_handler = CallbackQueryHandler(show_help, pattern="^show_help$")
